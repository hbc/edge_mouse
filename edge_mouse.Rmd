---
title: "Edge - Array analysis of inner ear cells"
output:
  html_document:
    theme: cosmo
    toc: true
    toc_depth: 4
    fig_caption: true
    fig_width: 8
    fig_height: 6
author: "Meeta Mistry"
---

```{r setup, echo=FALSE}

# Setup report details
clientname="Judith Kempfle"
clientemail="Judith_Kempfle@MEEI.HARVARD.EDU"
lablocation="HSCI - Edge Lab"
analystname="Meeta Mistry"
analystemail="mmistry@hsph.harvard.edu"
```

Array analysis for `r clientname` (`r clientemail`) at `r lablocation`. Contact `r analystname` (`r analystemail`) for additional details. Request from client was:

> Arrays run on Mouse Ref 8 v2.0 Expression Array Ambion to make the following comparisons:
>
> 1. Compare our stem cell derived hair cells to the actual hair cells and make an assumption about their maturity (Atoh1 primary vs. Atoh1 derived)
> 2. Compare our postnatal supporting cells to the more stem cell like proliferating Lgr5+ cells to assess stem cell potential of supporting cells (Sox2-GFP)
> 3. Compare hair cells and supporting cells (Atoh1-GFP vs. Sox2-GFP)


## Workflow
* Load in expression data and metadata
* Extract relevant information
* Make requested comparisons

## Setup

### Bioconductor and R libraries used

```{r libraries, echo=TRUE}

loadlibs <- function(){
library(Biobase)
library(limma)
library(lattice)
library(ggplot2)
library(RColorBrewer)
library(arrayQualityMetrics)
library(reshape)
library(dplyr)
library(illuminaio)
library(CHBUtils)
}
suppressPackageStartupMessages(loadlibs())
```

### Get variables
* get base directory for analyses
* specify data and results directories
* specify column headers used in metadata file


```{r variables, echo=TRUE}
# Setup directory variables
baseDir <- '.'
dataDir <- file.path(baseDir, "data")
metaDir <- file.path(baseDir, "meta")
resultsDir <- file.path(baseDir, "results")
```


## Load Data
We used the R package [illuminaio](http://www.bioconductor.org/packages/release/bioc/vignettes/illuminaio/inst/doc/illuminaio.pdf) to load in the data and extract the approapriate information. From the IDAT files we want to use the TrimmedMeanBinData which is the result of the outlier removal that Illumina perform as standard (consistent with GenomeStudio). In order to get probe annotations for the array and control probes we dowloaded the MouseRef8 v2.0 BGX file from the [Illumina website](http://support.illumina.com/array/downloads.html). 

```{r idatreader}

# Get path for all .idat files
dirlist <- scan(file.path(dataDir, "directories.txt"))
filenames = lapply(dirlist, function(x){
    path <- file.path(dataDir, x)
    files <- list.files(path=path, pattern=".idat")
    return(paste0(path, "/", files))})
filenames <- unlist(filenames)

# Decrypt the .idat files
theData = lapply(filenames, readIDAT)

# Extract expression information only
exprs = sapply(theData, function(x) {
  quants <- x$Quants
  out <- quants$TrimmedMeanBinData
  names(out) <- quants$CodesBinData
  return(out)})

# Get column names for expression matrix
getcolnames = lapply(filenames, function(x){
  sp <- strsplit(x, "/", fixed=T)
  s <- unlist(strsplit(sp[[1]][4], "_", fixed=T))
  cname <- paste(s[1], s[2], sep="_")
  return(cname)})
colnames(exprs)= unlist(getcolnames)

# Map rownames to Illumina IDs
bgxfile <- readBGX(file.path('meta/MouseRef-8_V2_0_R2_11278551_A.bgx'))
ref8 <- bgxfile$probes
ref8ctl <- bgxfile$controls

# Remove probes missing annotations
pids<-c(ref8$Array_Address_Id, ref8ctl$Array_Address_Id)
exprs.new <- exprs[which(rownames(exprs) %in% pids),]
```

## Background correction (using neqc::limma)
Expression values extarcted from IDAT files have not been normalized relative to other arrays, nor background corrected in the sense of negative controls are used to find a baseline. Illumina negative control probes (sequences with no match to the genome) can be used to correct observed signal intensity using a normal exponential convolution model to reduce bias and FPS. Adding small offset to corrected intensities can reduce FDR further (neqc offset = 16).

```{r bg-correct}

status <- rownames(exprs.new)
status <- replace(status, which(status %in% ref8ctl$Array_Address_Id == TRUE), "negative")
status <- replace(status, which(status %in% ref8$Array_Address_Id == TRUE), "regular")

#estimating proportion of detected probes
exp.prop <- propexpr(exprs.new, status=status, labels=c("negative", "regular") )

#background correction followed by quantile normalization and log2 transformation
exprs.bg <- neqc(exprs.new, status=status, negctrl="negative", regular="regular", offset=16)# returns matrix without control probes
```


## Create expression set object
```{r eset}
# Load metadata and rearrange
meta <- read.csv(file.path(metaDir, '2014-436_sample_key.csv'), header=T)
row.names(meta) <- paste(meta$array, meta$slide, sep="_")
meta <- meta[,-c(1,2)]

# Create feature data
keep <- which(ref8$Array_Address_Id %in% row.names(exprs.bg))
annot <- data.frame(ref8[keep, c('Probe_Id','Symbol', 'Entrez_Gene_ID', 'Cytoband')], row.names=ref8[keep, 'Array_Address_Id'])
annot <- annot[row.names(exprs.bg),]

# Create expresion set object
eset <- new("ExpressionSet", phenoData=as(meta, "AnnotatedDataFrame"), exprs=as.matrix(exprs.bg), 
            featureData=as(annot, "AnnotatedDataFrame"))

```


## Quality control
The results from the quality control check can be found at this [link](./results/reprot_aqm/index.html). The array intensity distributions and density plots are consistent across samples indicating there are no obvious outlier samples based on expression levels. The PCA figure below give us an idea of how samples tend to cluster; illustrating that based on the first and second principal component samples best cluster by celltype. Within the Atoh1 hair cells, we also see separation of the primary from the derived cells. **From the Lgr5+ sample group there is one major outlier (9982502025_D)**. From the inter-correlation heatmap the same sample appears to show a low correlation with all other samples in the dataset. This sample will be removed for downstream analysis.

```{r QC_report, echo=TRUE, eval=FALSE}

 arrayQualityMetrics(expressionset=eset, intgroup=c('celltype'),
                     outdir='./results/report_aqm', force=TRUE,  do.logtransform=FALSE)
```

### PCA
```{r pca, echo=FALSE, fig.align='center'}
mds(exprs.bg, condition =meta$celltype, k=length(colnames(exprs.bg)) - 1)
```

### Sample-to-sample correlation
```{r cormat, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE}
p = ggheatmap(cor(exprs.bg))
ggheatmap.show(p)
```

